{% extends 'core/base.html' %}

{% block content %}
<div class="form-container-wide">
    <h1 class="page-title">üé¨ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ù–æ–≤–æ–≥–æ –°–µ–∞–Ω—Å–∞</h1>

    <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            {{ message }}
            <button class="message-close" onclick="this.parentElement.remove()">√ó</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="sessionForm">
        {% csrf_token %}

        <div class="form-grid">
            <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="form-column">
                <div class="form-group">
                    <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ *</label>
                    <input type="text" name="title" id="title" class="form-input form-input-large"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞" required>
                </div>

                <div class="form-group">
                    <label for="date">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–µ–∞–Ω—Å–∞ *</label>
                    <input type="datetime-local" name="date" id="date" class="form-input form-input-large"
                           min="{{ min_date }}" required>
                    <small style="color: #aaa; font-size: 0.9rem;">
                        –ù–µ–ª—å–∑—è –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ—à–µ–¥—à—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
                    </small>
                </div>

                <div class="form-group">
                    <label for="duration">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç) *</label>
                    <input type="number" name="duration" id="duration" class="form-input form-input-large"
                           value="120" min="10" max="300" required>
                    <small style="color: #aaa; font-size: 0.9rem;">
                        –ú–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç, –º–∞–∫—Å–∏–º—É–º 300 –º–∏–Ω—É—Ç
                    </small>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
            <div class="form-column">
                <div class="form-group">
                    <label for="price">–¶–µ–Ω–∞ (—Ä—É–±.) *</label>
                    <input type="number" step="0.01" name="price" id="price" class="form-input form-input-large"
                           value="400.00" min="0.01" max="5000" required>
                </div>

                <div class="form-group">
                    <label for="seats_available">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç *</label>
                    <input type="number" name="seats_available" id="seats_available" class="form-input form-input-large"
                           value="50" min="1" max="500" required>
                    <small style="color: #aaa; font-size: 0.9rem;">
                        –û—Ç 1 –¥–æ 500 –º–µ—Å—Ç
                    </small>
                </div>

                <div class="form-group">
                    <label for="image">–ü–æ—Å—Ç–µ—Ä —Ñ–∏–ª—å–º–∞</label>
                    <div class="file-input-container">
                        <input type="file" name="image" id="image" accept="image/*" onchange="updateFileName(this)">
                        <label for="image" class="file-input-label">
                            üìÅ –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –ø–æ—Å—Ç–µ—Ä–∞
                            <div class="file-name" id="fileName">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ -->
            <div class="form-full-width">
                <div class="form-group">
                    <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ —Ñ–∏–ª—å–º–∞ *</label>
                    <textarea name="description" id="description" class="form-input form-input-large"
                              placeholder="–û–ø–∏—à–∏—Ç–µ —Å—é–∂–µ—Ç —Ñ–∏–ª—å–º–∞, –∞–∫—Ç–µ—Ä—Å–∫–∏–π —Å–æ—Å—Ç–∞–≤ –∏ –¥—Ä—É–≥—É—é –≤–∞–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é..."
                              required></textarea>
                </div>
            </div>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="button-group">
            <button type="submit" class="btn">
                –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∞–Ω—Å
            </button>
            <a href="{% url 'admin_panel' %}" class="btn" style="background: transparent; border: 2px solid #6a11cb;">
                –û—Ç–º–µ–Ω–∞
            </a>
        </div>
    </form>
</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
function updateFileName(input) {
    const fileName = input.files[0] ? input.files[0].name : '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
    document.getElementById('fileName').textContent = fileName;
}

// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
function setMinDateTime() {
    const now = new Date();

    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DDThh:mm
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const minDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    document.getElementById('date').min = minDateTime;
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
document.getElementById('sessionForm').addEventListener('submit', function(e) {
    const dateInput = document.getElementById('date');
    const durationInput = document.getElementById('duration');
    const priceInput = document.getElementById('price');
    const seatsInput = document.getElementById('seats_available');

    let errors = [];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞—Ç—ã
    const selectedDate = new Date(dateInput.value);
    const now = new Date();
    if (selectedDate < now) {
        errors.push('‚ùå –î–∞—Ç–∞ —Å–µ–∞–Ω—Å–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º');
        dateInput.style.borderColor = '#ff2e63';
    } else {
        dateInput.style.borderColor = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (durationInput.value < 10) {
        errors.push('‚ùå –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 10 –º–∏–Ω—É—Ç');
        durationInput.style.borderColor = '#ff2e63';
    } else if (durationInput.value > 300) {
        errors.push('‚ùå –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ 300 –º–∏–Ω—É—Ç');
        durationInput.style.borderColor = '#ff2e63';
    } else {
        durationInput.style.borderColor = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã
    if (priceInput.value <= 0) {
        errors.push('‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π');
        priceInput.style.borderColor = '#ff2e63';
    } else {
        priceInput.style.borderColor = '';
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ—Å—Ç
    if (seatsInput.value <= 0) {
        errors.push('‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º');
        seatsInput.style.borderColor = '#ff2e63';
    } else if (seatsInput.value > 500) {
        errors.push('‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 500');
        seatsInput.style.borderColor = '#ff2e63';
    } else {
        seatsInput.style.borderColor = '';
    }

    if (errors.length > 0) {
        e.preventDefault();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏
        let errorHtml = '';
        errors.forEach(error => {
            errorHtml += `<div class="message message-error">${error}</div>`;
        });

        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
        const messagesContainer = document.querySelector('.messages-container');
        if (messagesContainer) {
            messagesContainer.innerHTML = errorHtml;
        } else {
            const form = document.querySelector('.form-container-wide');
            const firstChild = form.firstChild;
            form.insertAdjacentHTML('afterbegin',
                `<div class="messages-container">${errorHtml}</div>`);
        }

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ—à–∏–±–∫–∞–º
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    setMinDateTime();

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∏–ª–µ–π –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
    const inputs = ['date', 'duration', 'price', 'seats_available'];
    inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('input', function() {
                this.style.borderColor = '';
            });
        }
    });
});

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
document.getElementById('price').addEventListener('blur', function() {
    const value = parseFloat(this.value);
    if (!isNaN(value)) {
        this.value = value.toFixed(2);
    }
});
</script>
{% endblock %}